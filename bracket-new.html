<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Turneringsbracket</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
body {
  margin: 0;
  background-color: #000;
  color: white;
  font-family: 'Teko', sans-serif;
  overflow: hidden;
}
.bracket-container {
  display: grid;
  grid-template-columns: repeat(9, 1fr);
  height: 100vh;
  width: 100vw;
  align-items: center;
}
.column {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%;
  gap: var(--match-spacing, 10px);
}
.match {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-height: 80px;
}
.match-info {
  font-size: 12px;
  color: #ffffff;
  margin-bottom: -2px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
}
.match-info .twitch {
  display: flex;
  align-items: center;
  font-weight: 600;
  color: #ffffff;
  margin-left: auto; /* Skjuter twitch-namnet längst till höger */
}
.match-info .twitch img {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  margin-right: 3px;
}
.team-box {
  display: flex;
  align-items: center;
  border-radius: 8px;
  overflow: hidden;
  width: 200px;
  height: 40px;
  border: 2px solid #5c0000;
  background-color: #3a0000;
}
.team-box .logo {
  width: 20%;
  max-width: 40px;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #5c0000;
  flex-shrink: 0;
}
.team-box .logo img {
  max-width: 70%;
  max-height: 70%;
  object-fit: contain;
}
.team-box .name {
  flex-grow: 1;
  padding: 0 5px;
  display: flex;
  align-items: center;
  color: white;
  font-weight: bold;
  font-size: 16px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  justify-content: left;
}
.team-box .score {
  width: 40px;
  text-align: center;
  font-weight: bold;
  font-size: 18px;
  flex-shrink: 0;
}
.column.right .team-box {
  flex-direction: row-reverse;
}
.column.right .team-box .name {
  justify-content: flex-end;
  text-align: right;
}
.column.right .team-box .score { order: 2; }
.column.right .team-box .logo { order: 0; }
.match.next .team-box {
  box-shadow: none;
  border-color: #ffcc00;
}
</style>
</head>
<body>
<div class="bracket-container">
  <div class="column" id="col16D1-8" style="--match-spacing:20px;"></div>
  <div class="column" id="col8D1-4" style="--match-spacing:150px;"></div>
  <div class="column" id="colQF1-2" style="--match-spacing:400px;"></div>
  <div class="column" id="colSF1" style="--match-spacing:80px;"></div>
  <div class="column" id="colFinal" style="--match-spacing:0px; justify-content:center;"></div>
  <div class="column right" id="colSF2" style="--match-spacing:80px;"></div>
  <div class="column right" id="colQF3-4" style="--match-spacing:400px;"></div>
  <div class="column right" id="col8D5-8" style="--match-spacing:150px;"></div>
  <div class="column right" id="col16D9-16" style="--match-spacing:20px;"></div>
</div>

<script>
const SHEET_ID = '1Fjlv7GXe2eU0oFRJC3ubNhuxnYa0KIFgngrqlUcA5lY';
const BASE = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;
let logos = {};
let matchMap = {};

function loadLogos() {
  Papa.parse(BASE + "Logotabell", {
    download: true,
    header: true,
    complete: function(results) {
      results.data.forEach(row => { if(row['Lag']) logos[row['Lag']] = row['Länk']; });
      loadBracket();
    }
  });
}

function adjustFontSize(el, maxWidth) {
  let fontSize = 16; 
  el.style.fontSize = fontSize + 'px';
  while (el.scrollWidth > maxWidth && fontSize > 16) {
    fontSize--;
    el.style.fontSize = fontSize + 'px';
  }
}

function createOrUpdateMatch(match, existing) {
  const logoA = logos[match['Lag A']] || 'https://via.placeholder.com/24';
  const logoB = logos[match['Lag B']] || 'https://via.placeholder.com/24';

  if (!existing) {
    const div = document.createElement('div');
    div.className = 'match';
    if(match['Nästa'] === 'TRUE') div.classList.add('next');

    const infoDiv = document.createElement('div');
    infoDiv.className = 'match-info';
    let infoHTML = `<span class="time-format-stage">${match['Tid'] || ''} | ${match['Format'] || ''} | ${match['Stage Info'] || ''}</span>`;
    if(match['Twitch'] && match['Twitch'].trim() !== '') {
      infoHTML += `<span class="twitch">
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/Twitch_Glitch_Logo_Purple.svg"> 
        ${match['Twitch']}
      </span>`;
    }
    infoDiv.innerHTML = infoHTML;
    div.appendChild(infoDiv);

    div.innerHTML += `
      <div class="team-box">
        <div class="logo"><img src="${logoA}"></div>
        <div class="name">${match['Lag A'] || ''}</div>
        <div class="score">${match['Score A']||''}</div>
      </div>
      <div class="team-box">
        <div class="logo"><img src="${logoB}"></div>
        <div class="name">${match['Lag B'] || ''}</div>
        <div class="score">${match['Score B']||''}</div>
      </div>
    `;
    div.querySelectorAll('.name').forEach(el => adjustFontSize(el, el.parentElement.offsetWidth - 40 - 40));
    return div;
  } else {
    const boxes = existing.querySelectorAll('.team-box');
    boxes[0].querySelector('.logo').innerHTML = `<img src="${logoA}">`;
    boxes[0].querySelector('.name').textContent = match['Lag A'] || '';
    boxes[0].querySelector('.score').textContent = match['Score A']||'';
    boxes[1].querySelector('.logo').innerHTML = `<img src="${logoB}">`;
    boxes[1].querySelector('.name').textContent = match['Lag B'] || '';
    boxes[1].querySelector('.score').textContent = match['Score B']||'';

    boxes.forEach(el => adjustFontSize(el.querySelector('.name'), el.offsetWidth - 40 - 40));

    if(match['Nästa'] === 'TRUE') existing.classList.add('next'); else existing.classList.remove('next');
    return existing;
  }
}

// Läs vilken bracketstorlek som är aktiv
function getActiveColumns(callback) {
  Papa.parse(BASE + "BracketData", {
    download: true,
    header: false,
    complete: function(results) {
      const val = results.data[4][14]?.trim() || '32';
      let activeCols;
      if (val === '32') activeCols = ['col16D1-8','col8D1-4','colQF1-2','colSF1','colFinal','colSF2','colQF3-4','col8D5-8','col16D9-16'];
      else if (val === '16') activeCols = ['col8D1-4','colQF1-2','colSF1','colFinal','colSF2','colQF3-4','col8D5-8'];
      else if (val === '8') activeCols = ['colQF1-2','colSF1','colFinal','colSF2','colQF3-4'];
      callback(activeCols);
    }
  });
}

// Ladda bracket
function loadBracket() {
  Papa.parse(BASE + "BracketData", {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data.filter(m => m.Match);
      const columns = {
        'col16D1-8': ['16D1','16D2','16D3','16D4','16D5','16D6','16D7','16D8'],
        'col8D1-4': ['8D1','8D2','8D3','8D4'],
        'colQF1-2': ['QF1','QF2'],
        'colSF1': ['SF1'],
        'colFinal': ['Final'],
        'colSF2': ['SF2'],
        'colQF3-4': ['QF3','QF4'],
        'col8D5-8': ['8D5','8D6','8D7','8D8'],
        'col16D9-16': ['16D9','16D10','16D11','16D12','16D13','16D14','16D15','16D16']
      };

      getActiveColumns(activeCols => {
        Object.keys(columns).forEach(colId => {
          if (!activeCols.includes(colId)) return;
          const col = document.getElementById(colId);
          columns[colId].forEach(matchId => {
            const matchData = data.find(m => m.Match.trim() === matchId);
            if(!matchData) return;
            if(!matchMap[matchId]) {
              const box = createOrUpdateMatch(matchData, null);
              matchMap[matchId] = box;
              col.appendChild(box);
            } else {
              createOrUpdateMatch(matchData, matchMap[matchId]);
            }
          });
        });
      });

    }
  });
}

loadLogos();
setInterval(loadLogos, 30000);
</script>
</body>
</html>
